#!/bin/bash

# Everything has to succeed
set -o errexit
set -o nounset

_manifest() {
  # Generate build-info
  bin/tin.sh build-info-files
  echo 'x bin/tin.sh bin/tin.sh'
  find tin -type f -name \*.py -o -name \*.sh
}

# TODO: rename to glue or yarn or something
# unyarn
create() {
  bin/create.py "$@"
}

py-deps() {
  bin/py_deps.py "$@"
}

bas() {
  _tmp/deps/bas.sh "$@"
}

# TODO: Handle docopt

Build() {
  # Everything here goes to stderr, so we don't have to redirect.
  create --out $CDI_OUT/tree-tools.tar.gz --no-prelude <<EOF
Package
bin/create.py bin/create
bin/tin.sh bin/tin
bin/py_deps.py bin/py-deps
bin/multi.py bin/multi
bin/hg-info.sh bin/hg-info
EOF

  poly build doc/
}

# not called 'test' 
Test() {
  # TODO: need a tool that runs all the functions that start with test-* in a
  # shell script?  Or maybe just ./all?
  ./tin-test.sh smoke-test
  ./run.sh all-unit-tests
}

Deploy() {
  # TODO: Use CDI_HG_REVISION
  #local version=$CDI_HG_REVISION

  local version=0.1

  local name=tree-tools-$version.tar.gz
  scp $CDI_OUT/tree-tools.tar.gz $PBI_DEPLOY_DEST/tree-tools/$name
  bas metadata-line $name >> $PBI_DEPLOY_DEST/tree-tools/Index.txt
}

"$@"
